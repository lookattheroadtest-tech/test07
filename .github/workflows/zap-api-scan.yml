name: ZAP API Scan (Authenticated)

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  zap-api-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fix workspace permissions
        run: chmod -R 777 .

      - name: Create output folder
        run: mkdir -p zap-output && chmod 777 zap-output

      - name: Ensure zap-scripts folder exists
        run: mkdir -p zap-scripts

      - name: Copy auth-header.py into container scripts directory
        run: cp zap-scripts/auth-header.py zap-scripts/auth-header.py

      - name: Run ZAP API Scan WITH Authentication Header
        run: |
          docker run --rm \
            -v "$(pwd)":/zap/wrk \
            -v "$(pwd)/zap-scripts":/zap/scripts \
            ghcr.io/zaproxy/zaproxy:stable \
            python3 /zap/zap-api-scan.py \
              -t "https://demo.testfire.net/swagger/properties.json" \
              -f openapi \
              --hook=/zap/scripts/auth-header.py \
              -I \
              -d \
              -r /zap/wrk/zap-output/zap-report.html \
              -J /zap/wrk/zap-output/zap-report.json

      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-html-report
          path: zap-output/zap-report.html

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-json-report
          path: zap-output/zap-report.json
